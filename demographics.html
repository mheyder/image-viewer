<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Analysis Demographics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .navigation {
            text-align: center;
            margin-bottom: 30px;
        }

        .nav-link {
            display: inline-block;
            padding: 10px 20px;
            margin: 0 10px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .data-input {
            margin-bottom: 30px;
            text-align: center;
        }

        .file-input-wrapper {
            display: inline-block;
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .file-input-wrapper:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        #jsonFile {
            position: absolute;
            left: -9999px;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            display: block;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 1.1em;
            font-weight: 500;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }

        .data-table {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .table-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        th:first-child {
            border-top-left-radius: 10px;
        }

        th:last-child {
            border-top-right-radius: 10px;
        }

        tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .no-data {
            text-align: center;
            padding: 60px;
            color: #888;
            font-size: 1.2em;
        }

        .percentage {
            color: #667eea;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Image Analysis Demographics</h1>
        <p class="subtitle">Statistical analysis of image enhancement data</p>
        
        <div class="navigation">
            <a href="index.html" class="nav-link">‚Üê Back to Gallery</a>
        </div>
        
        <div class="data-input">
            <label class="file-input-wrapper">
                <span>üìä Choose JSON File</span>
                <input type="file" id="jsonFile" accept=".json">
            </label>
        </div>

        <div id="content" style="display: none;">
            <div class="stats-overview" id="statsOverview">
                <!-- Stats cards will be inserted here -->
            </div>

            <div class="charts-container">
                <div class="chart-card">
                    <h3 class="chart-title">Rejections by Image Type</h3>
                    <div class="chart-container">
                        <canvas id="imageTypeChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3 class="chart-title">Rejections by Category</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="data-table">
                <h3 class="table-title">Detailed Breakdown by Image Type</h3>
                <table id="imageTypeTable">
                    <thead>
                        <tr>
                            <th>Image Type</th>
                            <th>Total Count</th>
                            <th>Rejection Count</th>
                            <th>Rejection Rate</th>
                        </tr>
                    </thead>
                    <tbody id="imageTypeTableBody">
                    </tbody>
                </table>
            </div>

            <div class="data-table">
                <h3 class="table-title">Detailed Breakdown by Rejection Category</h3>
                <table id="categoryTable">
                    <thead>
                        <tr>
                            <th>Rejection Category</th>
                            <th>Count</th>
                            <th>Percentage of Total Rejections</th>
                        </tr>
                    </thead>
                    <tbody id="categoryTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="noData" class="no-data">
            Please upload a JSON file to view demographics, or <a href="index.html" style="color: #667eea; text-decoration: none;">go back to the gallery</a> to upload data first.
        </div>
    </div>

    <script>
        let jsonData = [];
        let imageTypeChart = null;
        let categoryChart = null;

        document.getElementById('jsonFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        jsonData = JSON.parse(e.target.result);
                        if (!Array.isArray(jsonData)) {
                            jsonData = [jsonData];
                        }
                        
                        // Store data in localStorage
                        localStorage.setItem('imageGalleryData', JSON.stringify(jsonData));
                        
                        analyzeData();
                        showContent(true);
                    } catch (error) {
                        alert('Error parsing JSON file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        });

        // Load data from localStorage if available
        function loadStoredData() {
            const storedData = localStorage.getItem('imageGalleryData');
            if (storedData) {
                try {
                    jsonData = JSON.parse(storedData);
                    if (jsonData.length > 0) {
                        analyzeData();
                        showContent(true);
                        return true;
                    }
                } catch (error) {
                    console.error('Error loading stored data:', error);
                    localStorage.removeItem('imageGalleryData');
                }
            }
            return false;
        }

        function showContent(show) {
            document.getElementById('content').style.display = show ? 'block' : 'none';
            document.getElementById('noData').style.display = show ? 'none' : 'block';
        }

        function analyzeData() {
            const stats = calculateStatistics();
            updateStatsOverview(stats);
            updateCharts(stats);
            updateTables(stats);
        }

        function calculateStatistics() {
            const totalRecords = jsonData.length;
            
            // Count by image type
            const imageTypeStats = {};
            const categoryStats = {};
            let totalRejections = 0;

            jsonData.forEach(item => {
                const imageType = item.img_type || 'Unknown';
                const category = item.category;
                
                // Initialize image type stats
                if (!imageTypeStats[imageType]) {
                    imageTypeStats[imageType] = {
                        total: 0,
                        rejections: 0
                    };
                }
                
                imageTypeStats[imageType].total++;
                
                // Count rejections (items with a category are considered rejections)
                if (category && category.trim() !== '') {
                    imageTypeStats[imageType].rejections++;
                    totalRejections++;
                    
                    // Count by category
                    if (!categoryStats[category]) {
                        categoryStats[category] = 0;
                    }
                    categoryStats[category]++;
                }
            });

            return {
                totalRecords,
                totalRejections,
                imageTypeStats,
                categoryStats,
                acceptanceRate: ((totalRecords - totalRejections) / totalRecords * 100).toFixed(1),
                rejectionRate: (totalRejections / totalRecords * 100).toFixed(1)
            };
        }

        function updateStatsOverview(stats) {
            const statsOverview = document.getElementById('statsOverview');
            statsOverview.innerHTML = `
                <div class="stat-card">
                    <span class="stat-number">${stats.totalRecords}</span>
                    <span class="stat-label">Total Records</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.totalRejections}</span>
                    <span class="stat-label">Total Rejections</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.rejectionRate}%</span>
                    <span class="stat-label">Rejection Rate</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.acceptanceRate}%</span>
                    <span class="stat-label">Acceptance Rate</span>
                </div>
            `;
        }

        function updateCharts(stats) {
            createImageTypeChart(stats.imageTypeStats);
            createCategoryChart(stats.categoryStats);
        }

        function createImageTypeChart(imageTypeStats) {
            const ctx = document.getElementById('imageTypeChart').getContext('2d');
            
            if (imageTypeChart) {
                imageTypeChart.destroy();
            }

            const labels = Object.keys(imageTypeStats);
            const rejectionData = labels.map(type => imageTypeStats[type].rejections);
            const colors = generateColors(labels.length);

            imageTypeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: rejectionData,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label;
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createCategoryChart(categoryStats) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            if (categoryChart) {
                categoryChart.destroy();
            }

            const labels = Object.keys(categoryStats);
            const data = Object.values(categoryStats);
            const colors = generateColors(labels.length);

            categoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Rejection Count',
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 1,
                        borderColor: colors.map(color => color.replace('0.8', '1'))
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `Count: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    }
                }
            });
        }

        function updateTables(stats) {
            updateImageTypeTable(stats.imageTypeStats);
            updateCategoryTable(stats.categoryStats);
        }

        function updateImageTypeTable(imageTypeStats) {
            const tbody = document.getElementById('imageTypeTableBody');
            tbody.innerHTML = '';

            Object.entries(imageTypeStats)
                .sort((a, b) => b[1].rejections - a[1].rejections)
                .forEach(([type, data]) => {
                    const rejectionRate = ((data.rejections / data.total) * 100).toFixed(1);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${type}</td>
                        <td>${data.total}</td>
                        <td>${data.rejections}</td>
                        <td><span class="percentage">${rejectionRate}%</span></td>
                    `;
                    tbody.appendChild(row);
                });
        }

        function updateCategoryTable(categoryStats) {
            const tbody = document.getElementById('categoryTableBody');
            tbody.innerHTML = '';

            const totalRejections = Object.values(categoryStats).reduce((a, b) => a + b, 0);

            Object.entries(categoryStats)
                .sort((a, b) => b[1] - a[1])
                .forEach(([category, count]) => {
                    const percentage = ((count / totalRejections) * 100).toFixed(1);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${category}</td>
                        <td>${count}</td>
                        <td><span class="percentage">${percentage}%</span></td>
                    `;
                    tbody.appendChild(row);
                });
        }

        function generateColors(count) {
            const colors = [
                'rgba(102, 126, 234, 0.8)',
                'rgba(118, 75, 162, 0.8)',
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 205, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(199, 199, 199, 0.8)',
                'rgba(83, 102, 255, 0.8)'
            ];
            
            if (count <= colors.length) {
                return colors.slice(0, count);
            }
            
            // Generate additional colors if needed
            const additionalColors = [];
            for (let i = colors.length; i < count; i++) {
                const hue = (i * 137.508) % 360;
                additionalColors.push(`hsla(${hue}, 70%, 60%, 0.8)`);
            }
            
            return [...colors, ...additionalColors];
        }

        // Check for stored data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStoredData();
        });
    </script>
</body>
</html>
